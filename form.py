import os
import re
import datetime
from pathlib import Path

# é…ç½®å‚æ•°
REPORT_DIR = "weekly_reports"  # å‘¨æŠ¥æ–‡ä»¶å­˜æ”¾ç›®å½•
README_PATH = "README.md"      # README æ–‡ä»¶è·¯å¾„
MAX_ENTRIES = 10               # æœ€å¤šæ˜¾ç¤ºçš„å‘¨æŠ¥æ•°é‡
DATE_PATTERN = r"(\d{4}-\d{2}-\d{2})_(ç¬¬\d+æœŸ)_.*"  # æ–‡ä»¶ååŒ¹é…è§„åˆ™ï¼ˆç¤ºä¾‹ï¼š2025-04-30_ç¬¬1æœŸ_æ™ºè„‘æ—¶ä»£å‘¨æŠ¥.mdï¼‰

def extract_report_info(filename):
    """ä»æ–‡ä»¶åä¸­æå–æ—¥æœŸå’ŒæœŸæ•°"""
    match = re.match(DATE_PATTERN, filename)
    if not match:
        return None
    date_str, issue = match.groups()
    return {
        "date": date_str,
        "issue": issue,
        "filename": filename,
    }

def generate_markdown(reports):
    """ç”Ÿæˆ Markdown è¡¨æ ¼å†…å®¹"""
    markdown = "### ğŸ“Œ æœ€æ–°å‘¨æŠ¥\n\n"
    markdown += "| æ—¥æœŸ | æœŸæ•° | æ–‡ä»¶ |\n"
    markdown += "|------|------|------|\n"
    for report in reports:
        file_url = f"https://github.com/your-username/your-repo/blob/main/{REPORT_DIR}/{report['filename']}"
        markdown += f"| {report['date']} | {report['issue']} | [{report['filename']}]({file_url}) |\n"
    return markdown

def update_readme():
    # è·å–æ‰€æœ‰å‘¨æŠ¥æ–‡ä»¶
    report_dir = Path(REPORT_DIR)
    files = [f.name for f in report_dir.iterdir() if f.is_file()]
    
    # æå–å¹¶æ’åº
    reports = []
    for filename in files:
        info = extract_report_info(filename)
        if info:
            reports.append(info)
    reports.sort(key=lambda x: datetime.datetime.strptime(x["date"], "%Y-%m-%d"), reverse=True)
    reports = reports[:MAX_ENTRIES]  # å–æœ€æ–° MAX_ENTRIES æœŸ
    
    # ç”Ÿæˆ Markdown å†…å®¹
    new_content = generate_markdown(reports)
    
    # è¯»å–å¹¶æ›´æ–° README
    with open(README_PATH, "r", encoding="utf-8") as f:
        readme_lines = f.readlines()
    
    start_marker = "<!-- AUTOGENERATED_REPORTS -->\n"
    end_marker = "<!-- END_AUTOGENERATED -->\n"
    new_readme = []
    in_section = False
    
    for line in readme_lines:
        if line == start_marker:
            in_section = True
            new_readme.append(line)
            new_readme.append(new_content + "\n")
        elif line == end_marker:
            in_section = False
            new_readme.append(line)
        elif not in_section:
            new_readme.append(line)
    
    with open(README_PATH, "w", encoding="utf-8") as f:
        f.writelines(new_readme)
    
    print("README.md å·²æ›´æ–°ã€‚")

if __name__ == "__main__":
    update_readme()